version: "3.7"
services:
  emu-app:
    build:
      context: .
      dockerfile: Dockerfile-app
    links:
      - mongo
      - redis
    ports:
      - "64205:80"
    volumes:
      - type: bind
        source: ./data/results
        target: /app/results
  emu-daemon:
    build:
      context: .
      dockerfile: Dockerfile-daemon
    links:
      - dind
      - mongo
      - redis
    environment:
      DOCKER_HOST: tcp://dind:2375
    volumes:
      - type: bind
        source: ./emulators/images
        target: /app/images
      - type: bind
        source: ./data/results
        target: /app/results
  mongo:
    image: mongo
    volumes:
      - type: bind
        source: ./data/db
        target: /data/db
  redis:
    image: redis:alpine
  dind:
    image: docker:dind
    privileged: true
    volumes:
      - type: bind
        source: ./data/results
        target: /app/results
      - type: tmpfs
        target: /var/lib/docker
